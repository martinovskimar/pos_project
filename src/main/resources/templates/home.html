<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <!-- CSRF tokens for secure requests -->
    <meta name="csrf-token" th:content="${_csrf.token}"/>
    <meta name="csrf-header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Script to define product mapping for dynamic button creation -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        var productMapping = /*[[${productMapping}]]*/ {};
        /*]]>*/
    </script>
    <!-- jQuery, Popper.js, and Bootstrap JavaScript for interactive elements -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


</head>
<body>
<!-- Main container for the page -->
<div class="container-fluid">
    <div class="row">
        <!-- Left Section - Bill Creation -->
        <div class="col-md-4">
            <div class="bill-creation">
                <!-- Display user and bill information -->
                <h3>Bill Creation</h3>
                <div class="user-info">
                    <p><strong>User:</strong> <span id="userName" th:text="${loggedInUserName}">[UserName]</span></p>
                    <p><strong>Date:</strong> <span id="currentDate" th:text="${currentDate}">[CurrentDate]</span></p>
                    <p><strong>Time:</strong> <span id="currentTime" th:text="${currentTime}">[CurrentTime]</span></p>
                    <p><strong>Check Number:</strong> <span id="checkNumberDisplay" th:text="${checkNumber}">[CheckNumber]</span></p>
                    <p><strong>Table Number:</strong> <span id="tableNumberDisplay"></span></p>
                </div>
                <div id="bill-creation" style="overflow-y: auto; max-height: 300px; margin-bottom: 50px;">
                    <!-- Area where product entries will be added dynamically -->
                </div>
                <!-- Display for total price of the bill -->
                <div class="total-price" style="position: absolute; bottom: 0; width: calc(100% - 30px); background-color: white; padding: 10px; border-top: 1px solid #ccc;">
                    <strong>Total: $</strong><span id="total-price">0.00</span>
                </div>
            </div>
        </div>

        <!-- Middle Section - Product Buttons -->
        <div class="col-md-6">
            <div class="button-section">
                <div class="row mb-3">
                    <div class="col">
                        <button type="button" class="btn btn-primary btn-block" id="drinks-button">Drinks</button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-secondary btn-block" id="food-button">Food</button>

                    </div>
                </div>
                <!-- Dynamic content area for product buttons -->
                <div id="dynamic-content">
                    <!-- The following blocks will dynamically render buttons based on product mapping -->
                    <div class="row mb-3">
                        <th:block th:each="buttonId : ${buttonIdsRow1}">
                            <div class="col">
                                <th:block th:each="product : ${products}">
                                    <button type="button" th:if="${product.buttonId == buttonId}" th:text="${product.productName}" th:data-product-name="${product.productName}" th:data-product-price="${product.price}" class="product-button btn btn-info btn-block" th:attr="data-button-id=${buttonId}"></button>
                                </th:block>
                                <!-- The following button will not be rendered if there is no product associated with buttonId -->
                                <th:block th:if="${#lists.contains(products.![buttonId], buttonId)}">
                                    <button type="button" class="btn btn-info btn-block" th:text="${buttonId}" th:attr="data-button-id=${buttonId}" style="display: none;"></button>
                                </th:block>
                            </div>
                        </th:block>
                        <div class="col">
                            <button type="button" class="btn btn-danger btn-block" data-button-id="button2-5">Draught</button>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <th:block th:each="buttonId : ${buttonIdsRow2}">
                            <div class="col">
                                <th:block th:each="product : ${products}">
                                    <button type="button" th:if="${product.buttonId == buttonId}" th:text="${product.productName}" th:data-product-name="${product.productName}" th:data-product-price="${product.price}" class="product-button btn btn-info btn-block" th:attr="data-button-id=${buttonId}"></button>
                                </th:block>
                                <!-- The following button will not be rendered if there is no product associated with buttonId -->
                                <th:block th:if="${#lists.contains(products.![buttonId], buttonId)}">
                                    <button type="button" class="btn btn-info btn-block" th:text="${buttonId}" th:attr="data-button-id=${buttonId}" style="display: none;"></button>
                                </th:block>
                            </div>
                    </th:block>
                    <div class="col"><button type="button" class="btn btn-danger btn-block" id="whiskey-button">Whiskey</button></div>
                </div>

                <div class="row mb-3">
                    <th:block th:each="buttonId : ${buttonIdsRow3}">
                        <div class="col">
                            <th:block th:each="product : ${products}">
                                <button type="button" th:if="${product.buttonId == buttonId}" th:text="${product.productName}" th:data-product-name="${product.productName}" th:data-product-price="${product.price}" class="product-button btn btn-info btn-block" th:attr="data-button-id=${buttonId}"></button>
                            </th:block>
                            <!-- The following button will not be rendered if there is no product associated with buttonId -->
                            <th:block th:if="${#lists.contains(products.![buttonId], buttonId)}">
                                <button type="button" class="btn btn-info btn-block" th:text="${buttonId}" th:attr="data-button-id=${buttonId}" style="display: none;"></button>
                            </th:block>
                        </div>
                    </th:block>
                    <div class="col"><button type="button" class="btn btn-danger btn-block" id="spirits-button">Spirits</button></div>
                </div>


                <div class="row mb-3">
                    <th:block th:each="buttonId : ${buttonIdsRow4}">
                        <div class="col">
                            <th:block th:each="product : ${products}">
                                <button type="button" th:if="${product.buttonId == buttonId}" th:text="${product.productName}" th:data-product-name="${product.productName}" th:data-product-price="${product.price}" class="product-button btn btn-info btn-block" th:attr="data-button-id=${buttonId}"></button>
                            </th:block>
                            <!-- The following button will not be rendered if there is no product associated with buttonId -->
                            <th:block th:if="${#lists.contains(products.![buttonId], buttonId)}">
                                <button type="button" class="btn btn-info btn-block" th:text="${buttonId}" th:attr="data-button-id=${buttonId}" style="display: none;"></button>
                            </th:block>
                        </div>
                    </th:block>
                    <div class="col"><button type="button" class="btn btn-danger btn-block" id="minerals-button">Minerals</button></div>
                </div>


                <div class="row mb-3">
                    <th:block th:each="buttonId : ${buttonIdsRow5}">
                        <div class="col">
                            <th:block th:each="product : ${products}">
                                <button type="button" th:if="${product.buttonId == buttonId}" th:text="${product.productName}" th:data-product-name="${product.productName}" th:data-product-price="${product.price}" class="product-button btn btn-info btn-block" th:attr="data-button-id=${buttonId}"></button>
                            </th:block>
                            <!-- The following button will not be rendered if there is no product associated with buttonId -->
                            <th:block th:if="${#lists.contains(products.![buttonId], buttonId)}">
                                <button type="button" class="btn btn-info btn-block" th:text="${buttonId}" th:attr="data-button-id=${buttonId}" style="display: none;"></button>
                            </th:block>
                        </div>
                    </th:block>
                    <div class="col"><button type="button" class="btn btn-danger btn-block" id="tea-coffee-button">Tea/Coffee</button></div>
                </div>


                <div class="row mb-3">
                    <th:block th:each="buttonId : ${buttonIdsRow6}">
                        <div class="col">
                            <th:block th:each="product : ${products}">
                                <button type="button" th:if="${product.buttonId == buttonId}" th:text="${product.productName}" th:data-product-name="${product.productName}" th:data-product-price="${product.price}" class="product-button btn btn-info btn-block" th:attr="data-button-id=${buttonId}"></button>
                            </th:block>
                            <!-- The following button will not be rendered if there is no product associated with buttonId -->
                            <th:block th:if="${#lists.contains(products.![buttonId], buttonId)}">
                                <button type="button" class="btn btn-info btn-block" th:text="${buttonId}" th:attr="data-button-id=${buttonId}" style="display: none;"></button>
                            </th:block>
                        </div>
                    </th:block>
                    <div class="col"><button type="button" class="btn btn-danger btn-block" data-button-id="button7-5">Item 7-5</button></div>
                </div>


                <div class="row mb-3">
                    <th:block th:each="buttonId : ${buttonIdsRow7}">
                        <div class="col">
                            <th:block th:each="product : ${products}">
                                <button type="button" th:if="${product.buttonId == buttonId}" th:text="${product.productName}" th:data-product-name="${product.productName}" th:data-product-price="${product.price}" class="product-button btn btn-info btn-block" th:attr="data-button-id=${buttonId}"></button>
                            </th:block>
                            <!-- The following button will not be rendered if there is no product associated with buttonId -->
                            <th:block th:if="${#lists.contains(products.![buttonId], buttonId)}">
                                <button type="button" class="btn btn-info btn-block" th:text="${buttonId}" th:attr="data-button-id=${buttonId}" style="display: none;"></button>
                            </th:block>
                        </div>
                    </th:block>
                    <div class="col"><button type="button" class="btn btn-danger btn-block" data-button-id="button8-5">Item 8-5</button></div>
                </div>


                <div class="row mb-3">
                    <th:block th:each="buttonId : ${buttonIdsRow8}">
                        <div class="col">
                            <th:block th:each="product : ${products}">
                                <button type="button" th:if="${product.buttonId == buttonId}" th:text="${product.productName}" th:data-product-name="${product.productName}" th:data-product-price="${product.price}" class="product-button btn btn-info btn-block" th:attr="data-button-id=${buttonId}"></button>
                            </th:block>
                            <!-- The following button will not be rendered if there is no product associated with buttonId -->
                            <th:block th:if="${#lists.contains(products.![buttonId], buttonId)}">
                                <button type="button" class="btn btn-info btn-block" th:text="${buttonId}" th:attr="data-button-id=${buttonId}" style="display: none;"></button>
                            </th:block>
                        </div>
                    </th:block>
                    <div class="col"><button type="button" class="btn btn-danger btn-block" data-button-id="button9-5">Item 9-5</button></div>
                </div>

            </div>
            </div>
        </div>
        <!-- Right Section - Control Buttons -->
        <div class="col-md-2">
            <div class="button-section">
                <!-- Admin button, visible only to users with 'ROLE_ADMIN' -->
                <div class="row mb-3" sec:authorize="hasRole('ROLE_ADMIN')">
                    <div class="col">
                        <a th:href="@{/admin}" class="btn btn-success btn-block">Admin</a>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <button type="button" class="btn btn-success btn-block send-button">Send</button>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <button type="button" class="btn btn-success btn-block" id="print-button">Print</button>

                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <button type="button" class="btn btn-success btn-block" id="cancel-button">Cancel</button>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <button id="void-button" type="button" class="btn btn-success btn-block">Void</button>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <button id="begin-table-btn" class="btn btn-success btn-block">Begin Table</button>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <button type="button" class="btn btn-success btn-block" id="open-table-btn">Open Table</button>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <button type="button" class="btn btn-success btn-block" id="pay-button">Pay</button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <a th:href="@{/bill-functions}" class="btn btn-success btn-block" id="function-button">Function</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Table Number Modal -->
<div class="modal" id="tableNumberModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enter Table Number</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="number" id="tableNumberInput" class="form-control" placeholder="Table Number">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="submitTableNumber">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal" id="paymentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Payment Method</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <button class="btn btn-primary btn-block" onclick="processPayment('Cash')">Cash</button>
                <button class="btn btn-secondary btn-block" onclick="processPayment('Visa')">Visa</button>
                <button class="btn btn-info btn-block" onclick="processPayment('MasterCard')">MasterCard</button>
                <button class="btn btn-warning btn-block" onclick="processPayment('Amex')">Amex</button>
            </div>
        </div>
    </div>
</div>

<!-- Unpaid Bills Modal -->
<div class="modal fade" id="unpaidBillsModal" tabindex="-1" role="dialog" aria-labelledby="unpaidBillsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unpaidBillsModalLabel">Unpaid Bills</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="unpaidBillsList">
                <!-- Unpaid bills will be listed here in a table format -->
            </div>
        </div>
    </div>
</div>
<!-- Whiskey Modal -->
<div class="modal fade" id="whiskeyModal" tabindex="-1" role="dialog" aria-labelledby="whiskeyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="whiskeyModalLabel">Select Whiskey</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <th:block th:each="rowIndex : ${#numbers.sequence(0, 3)}">
                        <div class="row mb-2">
                            <div th:each="colIndex : ${#numbers.sequence(0, 3)}" class="col-3">
                                <th:block th:each="product : ${products}">
                                    <button type="button" th:if="${product.buttonId == whiskeyButtons[(rowIndex * 4) + colIndex]}"
                                            th:text="${product.productName}"
                                            th:data-product-name="${product.productName}"
                                            th:data-product-price="${product.price}"
                                            class="product-button btn btn-outline-primary btn-block mb-2"
                                            th:attr="data-button-id=${whiskeyButtons[(rowIndex * 4) + colIndex]}"></button>
                                </th:block>
                                <!-- The following button will not be rendered if there is no product associated with buttonId -->
                                <th:block th:if="${#lists.contains(products.![buttonId], whiskeyButtons[(rowIndex * 4) + colIndex])}">
                                    <button type="button" class="btn btn-outline-primary btn-block mb-2" style="display: none;"
                                            th:text="${whiskeyButtons[(rowIndex * 4) + colIndex]}"
                                            th:attr="data-button-id=${whiskeyButtons[(rowIndex * 4) + colIndex]}"></button>
                                </th:block>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Spirits Modal -->
<div class="modal fade" id="spiritsModal" tabindex="-1" role="dialog" aria-labelledby="spiritsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="spiritsModalLabel">Select Spirits</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <th:block th:each="rowIndex : ${#numbers.sequence(0, 3)}">
                        <div class="row mb-2">
                            <div th:each="colIndex : ${#numbers.sequence(0, 3)}" class="col-3">
                                <th:block th:each="product : ${products}">
                                    <button type="button" th:if="${product.buttonId == spiritsButtons[(rowIndex * 4) + colIndex]}"
                                            th:text="${product.productName}"
                                            th:data-product-name="${product.productName}"
                                            th:data-product-price="${product.price}"
                                            class="product-button btn btn-outline-secondary btn-block mb-2"
                                            th:attr="data-button-id=${spiritsButtons[(rowIndex * 4) + colIndex]}"></button>
                                </th:block>
                                <!-- The following button will not be rendered if there is no product associated with buttonId -->
                                <th:block th:if="${#lists.contains(products.![buttonId], spiritsButtons[(rowIndex * 4) + colIndex])}">
                                    <button type="button" class="btn btn-outline-secondary btn-block mb-2" style="display: none;"
                                            th:text="${spiritsButtons[(rowIndex * 4) + colIndex]}"
                                            th:attr="data-button-id=${spiritsButtons[(rowIndex * 4) + colIndex]}"></button>
                                </th:block>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Minerals Modal -->
<div class="modal fade" id="mineralsModal" tabindex="-1" role="dialog" aria-labelledby="mineralsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mineralsModalLabel">Select Minerals</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <th:block th:each="rowIndex : ${#numbers.sequence(0, 3)}">
                        <div class="row mb-2">
                            <div th:each="colIndex : ${#numbers.sequence(0, 3)}" class="col-3">
                                <th:block th:each="product : ${products}">
                                    <button type="button" th:if="${product.buttonId == mineralsButtons[(rowIndex * 4) + colIndex]}"
                                            th:text="${product.productName}"
                                            th:data-product-name="${product.productName}"
                                            th:data-product-price="${product.price}"
                                            class="product-button btn btn-outline-info btn-block mb-2"
                                            th:attr="data-button-id=${mineralsButtons[(rowIndex * 4) + colIndex]}"></button>
                                </th:block>
                                <!-- The following button will not be rendered if there is no product associated with buttonId -->
                                <th:block th:if="${#lists.contains(products.![buttonId], mineralsButtons[(rowIndex * 4) + colIndex])}">
                                    <button type="button" class="btn btn-outline-info btn-block mb-2" style="display: none;"
                                            th:text="${mineralsButtons[(rowIndex * 4) + colIndex]}"
                                            th:attr="data-button-id=${mineralsButtons[(rowIndex * 4) + colIndex]}"></button>
                                </th:block>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Tea/Coffee Modal -->
<div class="modal fade" id="teaCoffeeModal" tabindex="-1" role="dialog" aria-labelledby="teaCoffeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teaCoffeeModalLabel">Select Tea/Coffee</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <th:block th:each="rowIndex : ${#numbers.sequence(0, 3)}">
                        <div class="row mb-2">
                            <div th:each="colIndex : ${#numbers.sequence(0, 3)}" class="col-3">
                                <th:block th:each="product : ${products}">
                                    <button type="button" th:if="${product.buttonId == teaCoffeeButtons[(rowIndex * 4) + colIndex]}"
                                            th:text="${product.productName}"
                                            th:data-product-name="${product.productName}"
                                            th:data-product-price="${product.price}"
                                            class="product-button btn btn-outline-warning btn-block mb-2"
                                            th:attr="data-button-id=${teaCoffeeButtons[(rowIndex * 4) + colIndex]}"></button>
                                </th:block>
                                <!-- The following button will not be rendered if there is no product associated with buttonId -->
                                <th:block th:if="${#lists.contains(products.![buttonId], teaCoffeeButtons[(rowIndex * 4) + colIndex])}">
                                    <button type="button" class="btn btn-outline-warning btn-block mb-2" style="display: none;"
                                            th:text="${teaCoffeeButtons[(rowIndex * 4) + colIndex]}"
                                            th:attr="data-button-id=${teaCoffeeButtons[(rowIndex * 4) + colIndex]}"></button>
                                </th:block>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
    </div>
</div>



<script th:inline="javascript">
    // Function to add a product to the bill
    // It creates a new div element with a checkbox and label for the product
  function addProductToBill(productName, productPrice) {
    var billSection = document.getElementById('bill-creation');
    var productEntry = document.createElement('div');
    var checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'bill-item-checkbox';
    var label = document.createElement('label');
    label.textContent = productName + ' - $' + productPrice;
    productEntry.appendChild(checkbox);
    productEntry.appendChild(label);
    billSection.appendChild(productEntry);
    calculateTotal();
    saveBillState();
  }

  // Function to remove selected products from the bill
  // Iterates through checkboxes and removes checked items from the bill
  function removeSelectedProducts() {
    var checkboxes = document.querySelectorAll('.bill-item-checkbox');
    checkboxes.forEach(function(checkbox) {
      if (checkbox.checked) {
        checkbox.parentNode.remove();
      }
    });
    calculateTotal();
    saveBillState();
  }
    // Function to save the current state of the bill to local storage
    // This can be used to restore the bill's state when the page is reloaded
  function saveBillState() {
    var billItems = [];
    document.querySelectorAll('#bill-creation div').forEach(function(div) {
        var label = div.querySelector('label').textContent;
        billItems.push(label);
    });
    localStorage.setItem('billItems', JSON.stringify(billItems));
}
    // Function to calculate the total price of all items in the bill
  function calculateTotal() {
  var totalPrice = 0;
  document.querySelectorAll('#bill-creation label').forEach(function(label) {
    var price = parseFloat(label.textContent.split(' - $')[1]);
    totalPrice += price;
  });
  document.getElementById('total-price').textContent = totalPrice.toFixed(2);
}

  // Event listener for product buttons
  document.addEventListener('DOMContentLoaded', function () {
    var productButtons = document.querySelectorAll('.product-button');
    productButtons.forEach(function (button) {
      button.addEventListener('click', function () {
        var productName = this.getAttribute('data-product-name');
        var productPrice = this.getAttribute('data-product-price');
        addProductToBill(productName, productPrice);
      });
    });

    // Event listener for the 'Void' button
    var voidButton = document.getElementById('void-button');
    voidButton.addEventListener('click', removeSelectedProducts);
  });

    // Event listener for 'Begin Table' button
    document.getElementById('begin-table-btn').addEventListener('click', function() {
        $('#tableNumberModal').modal('show');
    });

    // Event listener for 'Submit' button in modal
    document.getElementById('submitTableNumber').addEventListener('click', function() {
        var tableNumber = document.getElementById('tableNumberInput').value;
        document.getElementById('tableNumberDisplay').textContent = tableNumber;
        $('#tableNumberModal').modal('hide');
    });

// Asynchronous function to send the bill data to the server
async function sendBill() {
        // Retrieve CSRF token and header from meta tags
    var token = $("meta[name='csrf-token']").attr("content");
    var header = $("meta[name='csrf-header']").attr("content");

        // Extract user name and table number from the page
    var userName = document.getElementById('userName').textContent;
    var tableNumber = parseInt(document.getElementById('tableNumberDisplay').textContent, 10);
        // Get product entries from the bill creation section
    var productEntries = document.querySelectorAll('#bill-creation div');

        // Create promises to fetch product IDs based on their names
    var productPromises = Array.from(productEntries).map(async entry => {
        var productName = entry.querySelector('label').textContent.split(' - $')[0];
        var productId = await getProductIDByName(productName);
        return { productId: productId, quantity: 1 }; // Assuming 1 quantity per product
    });
        // Resolve all promises and obtain product IDs
    var billProducts = await Promise.all(productPromises);

        // Set default URL and request type for a new bill (POST)
    var url = '/api/bills'; // Default URL for POST
    var requestType = 'POST'; // Default request type

        // If updating an existing bill, adjust URL and request type (PUT)
    if (currentBillId) {
        url = `/api/bills/${currentBillId}`; // Update URL for PUT
        requestType = 'PUT'; // Change request type to PUT
    }
        // Construct payload for the bill
    var payload = {
        userName: userName,
        billId: currentBillId,
        tableNumber: tableNumber,
        billProducts: billProducts
    };
    //debugging
    console.log("Payload being sent:", payload);

    // Send the request to the server
    $.ajax({
        url: url,
        type: requestType,
        contentType: 'application/json',
        data: JSON.stringify(payload),
        beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        },
        success: function(response) {
            console.log('Bill sent successfully', response);
            if (!currentBillId) {
                // Reset the currentBillId if it's a new bill
                currentBillId = null;
            } else {
                // Refresh the list of unpaid bills if updating an existing bill
                fetchUnpaidBills();
            }
            window.location.href = '/home';
        },
        error: function(error) {
            console.log('Error sending bill', error);
        }
    });
    localStorage.removeItem('billItems');
}

// Function to print the bill
function printBill() {
        // Retrieve user name, date, time, table number, and total price from the document
    var userName = document.getElementById('userName').textContent;
    var currentDate = document.getElementById('currentDate').textContent;
    var currentTime = document.getElementById('currentTime').textContent;
    var tableNumber = document.getElementById('tableNumberDisplay').textContent;
    var totalPrice = document.getElementById('total-price').textContent;

         // Select all product entries in the bill creation section
    var productEntries = document.querySelectorAll('#bill-creation div label');
    var productSummary = {};

        // Iterate over the product entries and count the quantities of each product
    productEntries.forEach(function(label) {
        var productInfo = label.textContent.split(' - $')[0];
        productSummary[productInfo] = (productSummary[productInfo] || 0) + 1;
    });

    // Generate bill content for printing
    var billContent = '<ul>';
    for (var product in productSummary) {
        billContent += '<li>' + product + ' x' + productSummary[product] + '</li>';
    }
    billContent += '</ul>';

        // Open a new window for printing
    var printWindow = window.open('', '', 'height=600,width=800');

         // Write the HTML content for the bill in the new window
    printWindow.document.write('<html><head><title>Print Bill</title>');
    printWindow.document.write('</head><body>');
    printWindow.document.write('<h3>Bill Details</h3>');
    printWindow.document.write('<p><strong>User:</strong> ' + userName + '</p>');
    printWindow.document.write('<p><strong>Date:</strong> ' + currentDate + '</p>');
    printWindow.document.write('<p><strong>Time:</strong> ' + currentTime + '</p>');
    printWindow.document.write('<p><strong>Table Number:</strong> ' + tableNumber + '</p>');
    printWindow.document.write('<hr>');
    printWindow.document.write(billContent);
    printWindow.document.write('<p><strong>Total Price: $</strong>' + totalPrice + '</p>');
    printWindow.document.write('</body></html>');

        // Close the document for printing
    printWindow.document.close();
    printWindow.focus();

        // Set a timeout to ensure the window is ready for printing
    setTimeout(function() {
        printWindow.print();
        printWindow.close();
    }, 1000);
}
// Function to process the payment for a bill
async function processPayment(paymentMethod) {
        // Retrieve CSRF token and header for secure AJAX request
    var token = $("meta[name='csrf-token']").attr("content");
    var header = $("meta[name='csrf-header']").attr("content");

         // Extract user name and table number from the document
    var userName = document.getElementById('userName').textContent;
    var tableNumber = parseInt(document.getElementById('tableNumberDisplay').textContent, 10);
        // Select all product entries in the bill creation section
    var productEntries = document.querySelectorAll('#bill-creation div');

        // Create promises to fetch product IDs based on product names
    var productPromises = Array.from(productEntries).map(async entry => {
        var productName = entry.querySelector('label').textContent.split(' - $')[0];
        var productId = await getProductIDByName(productName);
        return { productId: productId, quantity: 1 }; // Assuming 1 quantity per product
    });
         // Resolve all product ID promises
    var billProducts = await Promise.all(productPromises);

        // Create payload for the POST request
    var payload = {
        userName: userName,
        tableNumber: tableNumber,
        billProducts: billProducts,
        payment: paymentMethod,
        billId: currentBillId
    };
    // AJAX POST request to send the bill information
    $.ajax({
        url: '/api/bills',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        },
        success: function(response) {
            console.log('Bill sent successfully', response);
            // Refresh the list of unpaid bills
            fetchUnpaidBills();
            // Redirect to the home page after successful bill submission
            window.location.href = '/home';
        },
        error: function(error) {
            console.log('Error sending bill', error);
        }
    });
    // Clear local storage item 'billItems' after sending the bill
    localStorage.removeItem('billItems');
}

// Function to fetch unpaid bills from the server
async function fetchUnpaidBills() {
        // Sending request to fetch unpaid bills
    const response = await fetch('/api/bills/unpaid');
    if (!response.ok) {
        throw new Error(`Error: ${response.status}`);
    }
         // Parsing the JSON response
    const bills = await response.json();
        // Populating the unpaid bills in the modal
    populateUnpaidBillsModal(bills);
}

// Function to populate the unpaid bills in a modal
function populateUnpaidBillsModal(bills) {
    const listContainer = document.getElementById('unpaidBillsList');
        // Clearing existing content in the modal
    listContainer.innerHTML = '';

        // Create a table structure
    const table = document.createElement('table');
    table.className = 'table';

        // Add table header
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>Bill ID</th>
            <th>Table</th>
            <th>User</th>
            <th>Date</th>
            <th>Time</th>
<!--            <th>Price</th>-->
            <th>Select</th>
        </tr>`;
    table.appendChild(thead);

    // Add table body
    const tbody = document.createElement('tbody');
    bills.forEach(bill => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${bill.billId}</td>
            <td>${bill.tableNumber}</td>
            <td>${bill.user.username}</td>
            <td>${bill.date}</td>
            <td>${bill.time}</td>
<!--            <td>$${bill.totalPrice.toFixed(2)}</td>-->
            <td><button class="btn btn-primary" onclick="openBill(${bill.billId})">Open</button></td>`;
            // Appending each bill as a row in the table
        tbody.appendChild(row);
    });
        // Appending body to the table
    table.appendChild(tbody);

         // Appending the table to the modal container
    listContainer.appendChild(table);
         // Displaying the modal with the unpaid bills
    $('#unpaidBillsModal').modal('show');
}

let currentBillId = null;

// Function to open a specific bill by its ID
async function openBill(billId) {
        // Setting the current bill ID
    currentBillId = billId;
    try {
             // Fetching bill details from the server
        const response = await fetch(`/api/bills/${billId}`);
        if (!response.ok) {
            throw new Error(`Error: ${response.status}`);
        }
            // Parsing the JSON response
        const billDetails = await response.json();

            // Clear the current bill creation section and update it with the fetched bill details
        document.getElementById('bill-creation').innerHTML = '';
        document.getElementById('userName').textContent = billDetails.user.username;
        document.getElementById('currentDate').textContent = billDetails.date;
        document.getElementById('currentTime').textContent = billDetails.time;
        document.getElementById('tableNumberDisplay').textContent = billDetails.tableNumber;
        document.getElementById('checkNumberDisplay').textContent = billId;

            // Add products to bill creation
        billDetails.billProducts.forEach(billProduct => {
        const productName = billProduct.product.productName;
        const productPrice = billProduct.product.price;
        addProductToBill(productName, productPrice);
        });

        // Close the modal
        $('#unpaidBillsModal').modal('hide');

    } catch (error) {
        console.error('Failed to open bill:', error);
    }
}

// Event listener for print button
document.getElementById('print-button').addEventListener('click', printBill);

//Event listner for Cancel button
document.getElementById('cancel-button').addEventListener('click', function() {
    clearBillCreation();
    window.location.href = '/login';
});

// Event listener for 'Send' button
document.querySelector('.send-button').addEventListener('click', sendBill);

// Function to get product ID by name
async function getProductIDByName(productName) {
    const response = await fetch(`/api/products/id?productName=${encodeURIComponent(productName)}`);
    if (!response.ok) {
        throw new Error(`Error: ${response.status}`);
    }
    return response.json();
}

//Event listener for 'Pay' button
document.getElementById('pay-button').addEventListener('click', function() {
$('#paymentModal').modal('show');
});

//Event listener for 'Open Table' button
document.getElementById('open-table-btn').addEventListener('click', function() {
fetchUnpaidBills();
});

function initializeModalListeners() {
         // Event listener for 'Whiskey' button
    document.getElementById('whiskey-button').addEventListener('click', function() {
        $('#whiskeyModal').modal('show');
    });
        // Event listener for 'Spirits' button
    document.getElementById('spirits-button').addEventListener('click', function() {
        $('#spiritsModal').modal('show');
    });
        // Event listener for 'Minerals' button
    document.getElementById('minerals-button').addEventListener('click', function() {
        $('#mineralsModal').modal('show');
    });
        // Event listener for 'Tea/Coffee' button
    document.getElementById('tea-coffee-button').addEventListener('click', function() {
        $('#teaCoffeeModal').modal('show');
    });
}
// Event listener for when the DOM content is fully loaded
document.addEventListener('DOMContentLoaded', function () {
        // Save the initial state of dynamic content
    var initialState = document.getElementById('dynamic-content').innerHTML;

        // Initialize modal listeners
    initializeModalListeners();

// Ensures that any previous event listeners attached to these buttons are removed
function initializeButtonListeners() {
        // Select all elements with the class 'product-button'
    var productButtons = document.querySelectorAll('.product-button');
         // Iterate through each product button
    productButtons.forEach(function (button) {
            // Clone the current button to remove existing event listeners
        var newButton = button.cloneNode(true);
            // Replace the old button with the new cloned button
        button.parentNode.replaceChild(newButton, button);

             // Add an event listener to the new button
        newButton.addEventListener('click', function () {
                // Retrieve product name and price from the button's data attributes
            var productName = this.getAttribute('data-product-name');
            var productPrice = this.getAttribute('data-product-price');

                // Call the function to add the product to the bill
            addProductToBill(productName, productPrice);
        });
    });
}
    /*<![CDATA[*/
    var productsData = /*[[${products}]]*/ [];
    var productMapping = /*[[${productMapping}]]*/ {};
    /*]]>*/
//debugging
    console.log(productMapping);
    console.log(productsData);

// Function to add Food buttons
function displayFoodLayout() {
    var dynamicContent = document.getElementById('dynamic-content');
        // Clear existing content
    dynamicContent.innerHTML = ''; // Clear existing content

    console.log("Products Data:", productsData);
    console.log("Product Mapping:", productMapping);

         // Create 5 rows
    for (var i = 0; i < 5; i++) {
        var row = document.createElement('div');
        row.className = 'row mb-3';
             // Create 4 buttons per row
        for (var j = 0; j < 4; j++) {
            var col = document.createElement('div');
            col.className = 'col';
            var button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn btn-info btn-block';

                // Construct button ID
            var buttonId = 'foodBtn-' + (i+1) + '-' + (j+1);

                // Check if there is a product mapped to this button
            if (productMapping[buttonId]) {
                var productId = productMapping[buttonId];
                var product = productsData.find(p => p.productId === productId);
                if (product) {
                         // Set button text and data attributes if product is found
                    button.textContent = product.productName;
                    button.dataset.productName = product.productName;
                    button.dataset.productPrice = product.price;
                } else {
                    console.error("Product not found for ID:", productId);
                    button.textContent = buttonId;
                }
            } else {
                console.log("No product mapped for button ID:", buttonId);
                button.textContent = buttonId;
            }

            button.addEventListener('click', function() {
                if (this.dataset.productName && this.dataset.productPrice) {
                    addProductToBill(this.dataset.productName, this.dataset.productPrice);
                } else {
                    console.error("Product data not available for button:", this.id);
                }
            });

            col.appendChild(button);
            row.appendChild(col);
        }
        dynamicContent.appendChild(row);
    }
}

    // Event listener for the Food and Drinks buttons
    document.getElementById('food-button').addEventListener('click', displayFoodLayout);

document.getElementById('drinks-button').addEventListener('click', function() {
    var dynamicContent = document.getElementById('dynamic-content');
        // Reset dynamic content to its initial state
    dynamicContent.innerHTML = initialState;
         // Reinitialize modal listeners for the new dynamic content
    initializeModalListeners();
         // Reinitialize button listeners for the new dynamic content
    initializeButtonListeners();
    });
});

document.addEventListener('DOMContentLoaded', function () {
        // Function call to restore the bill state from the previous session, if any
    restoreBillState();
});

function restoreBillState() {
        // Retrieve saved bill items from local storage
    var billItems = JSON.parse(localStorage.getItem('billItems'));
    if (billItems) {
            // If there are saved bill items, recreate them in the bill creation section
        billItems.forEach(function(item) {
            var parts = item.split(' - $');
            var productName = parts[0];
            var productPrice = parts[1];
            addProductToBill(productName, productPrice);
        });
    }
}

// Function to clear the bill creation section
function clearBillCreation() {
        // Clear the HTML content of the bill creation section
    document.getElementById('bill-creation').innerHTML = '';

         // Reset the total price display to zero
    document.getElementById('total-price').textContent = '0.00';

        // Clear the saved bill state from localStorage
    localStorage.removeItem('billItems');
}

// Event listener for Cancel button
document.getElementById('cancel-button').addEventListener('click', function() {
         // Clear the current bill creation section
    clearBillCreation();

    // Redirect to login
    window.location.href = '/login';
});

</script>
</body>
</html>
